<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <title>websocket test</title>
    <script>
        var socket;

        function Connect() {
            try {
                socket = new WebSocket('ws://localhost:8081');
            } catch (e) {
                console.log("连接出现error:" + e);
                return;
            }
            socket.onopen = sOpen;
            socket.onerror = sError;
            socket.onmessage = sMessage;
            socket.onclose = sClose;
        }

        function sOpen() {
            console.log("连接建立成功");
        }

        var b;

        function sError(e) {
            b = e;
            console.log("error:" + e);
        }

        function sClose(e) {
            console.log("connect closed2:" + e.code);
        }

        function Send() {
            socket.send(document.getElementById("msg").value);
        }

        function Close() {
            socket.close();
        }

        // -------------------------------------------------------------------------------------------------------------------------

        function createTag(tagName, content) {  // 创建标签。
            return `<${tagName}>${content}</${tagName}>`;
        }

        function extractTagContent(input, tagName) {  // 从标签中提取内容。
            const regex = new RegExp(`<${tagName}>(.*?)<\/${tagName}>`, 'g');
            const matches = input.match(regex);

            if (matches) {
                const contents = matches.map(match => {
                    const content = match.match(/<.*?>(.*?)<\/.*?>/)[1];
                    return content;
                });
                return contents;
            } else {
                return [];
            }
        }

        function clear(id) {
            document.getElementById(id).value = "";
        }

        function append(content) {
            var dynamic_body = document.getElementById("dynamic_body");
            var new_row = document.createElement("tr");
            var name_cell = document.createElement("td");
            name_cell.textContent = content;
            new_row.appendChild(name_cell);
            dynamic_body.appendChild(new_row);
        }
    </script>
</head>

<body>

<div>
    <input id="username" type="text">
    <input id="password" type="password">
    <button id="register" onclick="register();">注册</button>
    <button id="login" onclick="login();">登录</button>
</div>


<!--<table border="1px" style="width: 640px;text-align: center; margin: auto; table-layout: fixed;">-->
<!--    <thead>-->
<!--    <tr>-->
<!--        <th>内容</th>-->
<!--    </tr>-->
<!--    </thead>-->
<!--    <tbody id="dynamic_body">-->

<!--    </tbody>-->
<!--</table>-->

</body>

</html>
<script>
    var session, userId;
    Connect();  // 每次打开网页或者刷新网页，自动建立websocket连接。
    function sMessage(msg) {  // 接收来自服务器端的信息。
        var content = msg.data;
        var status = extractTagContent(content, "status");
        if (status == 200) {
            var message = extractTagContent(content, "message");
            if (message == "注册成功" || message == "注册失败") {  // 清空输入框。
                clear("username");
                clear("password");
                alert(message);
            } else if(message == "登陆成功" || message == "登陆失败") {
                clear("username");
                clear("password");
                alert(message);
                if(message == "登陆成功") {
                    session = extractTagContent(content, "session");
                    userId = extractTagContent(content, "userId");
                    console.log("session的内容是" + session);
                    console.log("userId的内容是" + userId);
                }
            }
        }
    }


    function register() {  // 发送注册请求。
        var username = document.getElementById("username").value,
            password = document.getElementById("password").value;
        if (username.length === 0 || password.length === 0) {
            alert("请输入用户名和密码");
            return;
        }
        var context = "";
        context += createTag("url", "/register");
        context += createTag("username", username);
        context += createTag("password", password);
        socket.send(context);
    }

    function login() {  // 发送登录请求。
        var username = document.getElementById("username").value,
            password = document.getElementById("password").value;
        if (username.length === 0 || password.length === 0) {
            alert("请输入用户名和密码");
            return;
        }
        var context = "";
        context += createTag("url", "/login");
        context += createTag("username", username);
        context += createTag("password", password);
        socket.send(context);
    }
</script>